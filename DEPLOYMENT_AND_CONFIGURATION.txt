DEPLOYMENT AND CONFIGURATION GUIDE
===================================

This guide covers deployment and configuration for both development and production environments.

================================================================================
PART 1: DEVELOPMENT SETUP
================================================================================

1.1 BACKEND DEVELOPMENT SETUP
-----------------------------

Prerequisites:
- Python 3.11 or higher
- MongoDB Atlas account (free tier works) or local MongoDB instance

Steps:

1. Navigate to backend directory:
   cd backend

2. Create virtual environment (recommended):
   python -m venv venv
   
   # Windows:
   venv\Scripts\activate
   
   # Linux/Mac:
   source venv/bin/activate

3. Install dependencies:
   pip install -r requirements.txt

4. Create .env file in project root (not in backend/):
   # Required
   OPENAI_API_KEY=your_openai_api_key_here
   TAVILY_API_KEY=your_tavily_api_key_here
   MONGODB_URI=your_mongodb_connection_string_here
   
   # Optional
   LOG_LEVEL=INFO
   USE_REDIS_CACHE=false
   REDIS_URL=redis://localhost:6379/0
   CORS_ORIGINS=http://localhost:3000
   ENVIRONMENT=development

5. Start development server:
   # Option 1: Direct uvicorn
   python -m uvicorn app.main:app --reload --port 8000
   
   # Option 2: Dev server script
   python dev_server.py

6. Verify backend is running:
   - API docs: http://localhost:8000/docs
   - Health check: http://localhost:8000/health


1.2 FRONTEND DEVELOPMENT SETUP
------------------------------

Prerequisites:
- Node.js 18.x or higher
- npm 9.x or higher

Steps:

1. Navigate to frontend directory:
   cd frontend

2. Install dependencies:
   npm install

3. Create .env.local file (optional, for custom backend URL):
   BACKEND_URL=http://localhost:8000
   
   Note: If BACKEND_URL is not set, frontend defaults to http://localhost:8000 in development

4. Start development server:
   npm run dev

5. Verify frontend is running:
   - Open: http://localhost:3000
   - Check browser console for errors


1.3 MONGODB SETUP (DEVELOPMENT)
--------------------------------

Option 1: MongoDB Atlas (Recommended)

1. Create account at https://www.mongodb.com/cloud/atlas
2. Create a free cluster (M0 tier)
3. Create database user:
   - Go to Database Access → Add New Database User
   - Set username and password
   - Save credentials securely
4. Whitelist IP address:
   - Go to Network Access → Add IP Address
   - Add your current IP or 0.0.0.0/0 for development (not recommended for production)
5. Get connection string:
   - Go to Clusters → Connect → Connect your application
   - Copy connection string
   - Replace <password> with your database user password
   - Format: mongodb+srv://username:password@cluster.mongodb.net/dbname?retryWrites=true&w=majority

Option 2: Local MongoDB

1. Install MongoDB locally
2. Start MongoDB service
3. Connection string: mongodb://localhost:27017/tavily_signals


1.4 REDIS SETUP (DEVELOPMENT - OPTIONAL)
-----------------------------------------

If you want to test Redis caching locally:

1. Install Redis:
   # Windows: Use WSL or Docker
   # Mac: brew install redis
   # Linux: sudo apt-get install redis-server

2. Start Redis:
   redis-server

3. Update .env:
   USE_REDIS_CACHE=true
   REDIS_URL=redis://localhost:6379/0

4. Verify connection:
   redis-cli ping
   # Should return: PONG


================================================================================
PART 2: PRODUCTION DEPLOYMENT
================================================================================

2.1 BACKEND DEPLOYMENT - AWS ELASTIC BEANSTALK
-----------------------------------------------

Prerequisites:
- AWS account
- AWS CLI installed and configured
- EB CLI installed: pip install awsebcli

Method 1: Using EB CLI (Recommended)

1. Navigate to backend directory:
   cd backend

2. Initialize Elastic Beanstalk:
   eb init
   
   Follow prompts:
   - Select region (e.g., us-east-1)
   - Select application name (e.g., tavily-backend)
   - Select platform: Python 3.11
   - Select platform branch: Python 3.11 running on 64bit Amazon Linux 2
   - Set up SSH: Yes (recommended)
   - Select keypair or create new one

3. Create environment:
   eb create tavily-backend-env
   
   This will:
   - Create EC2 instance(s)
   - Set up load balancer
   - Configure security groups
   - Deploy your application
   
   Note: First deployment takes 5-10 minutes

4. Set environment variables:
   eb setenv OPENAI_API_KEY=your_production_openai_key \
            TAVILY_API_KEY=your_production_tavily_key \
            MONGODB_URI=your_production_mongodb_uri \
            USE_REDIS_CACHE=true \
            REDIS_HOST=your-redis-endpoint.cache.amazonaws.com \
            REDIS_PORT=6379 \
            REDIS_DB=0 \
            CORS_ORIGINS=https://your-frontend-domain.vercel.app \
            LOG_LEVEL=WARNING \
            ENVIRONMENT=production

5. Deploy application:
   eb deploy

6. Check status:
   eb status

7. View logs:
   eb logs

8. Get application URL:
   eb open
   # Or check: eb status (shows CNAME)


Method 2: Using ZIP Upload (Alternative)

1. Create deployment package:
   cd backend
   python create_zip.py
   
   This creates: tavily-backend-v4.zip in project root

2. Upload via AWS Console:
   - Go to Elastic Beanstalk → Your Application → Your Environment
   - Click "Upload and Deploy"
   - Select the ZIP file
   - Add version label
   - Click "Deploy"

3. Set environment variables via AWS Console:
   - Go to Configuration → Software → Edit
   - Add environment properties (same as Method 1, Step 4)
   - Click "Apply"


2.2 FRONTEND DEPLOYMENT - VERCEL
---------------------------------

Prerequisites:
- Vercel account (sign up at vercel.com)
- GitHub repository connected (or use Vercel CLI)

Method 1: Via Vercel Dashboard (Recommended)

1. Go to Vercel Dashboard:
   https://vercel.com/new

2. Import your repository:
   - Click "Import Project"
   - Select your GitHub repository
   - Click "Import"

3. Configure project settings:
   - Framework Preset: Next.js (auto-detected)
   - Root Directory: frontend (IMPORTANT!)
   - Build Command: npm run build (runs in frontend directory)
   - Output Directory: .next (default)
   - Install Command: npm install (runs in frontend directory)

4. Set environment variables:
   - Go to Settings → Environment Variables
   - Add variable:
     Key: BACKEND_URL
     Value: https://your-eb-backend.elasticbeanstalk.com
     Environment: Production, Preview, Development (select all)
   - Click "Save"

5. Deploy:
   - Click "Deploy"
   - Wait for build to complete (2-3 minutes)
   - Your app will be live at: https://your-project.vercel.app


Method 2: Via Vercel CLI

1. Install Vercel CLI:
   npm install -g vercel

2. Login:
   vercel login

3. Navigate to frontend:
   cd frontend

4. Deploy:
   vercel
   
   Follow prompts:
   - Link to existing project or create new
   - Confirm settings
   - Deploy

5. Set environment variable:
   vercel env add BACKEND_URL
   # Enter your backend URL when prompted

6. Deploy to production:
   vercel --prod


2.3 MONGODB SETUP (PRODUCTION)
-------------------------------

1. Create MongoDB Atlas cluster:
   - Use M10 tier or higher for production
   - Enable backups
   - Enable monitoring

2. Configure network access:
   - Go to Network Access
   - Add IP address: 0.0.0.0/0 (allows all IPs)
     OR add specific Elastic Beanstalk IP ranges
   - For better security, use VPC peering (advanced)

3. Create database user:
   - Strong password (use password manager)
   - Save credentials securely

4. Get connection string:
   - Format: mongodb+srv://username:password@cluster.mongodb.net/dbname?retryWrites=true&w=majority
   - Use this in MONGODB_URI environment variable

5. Enable additional features:
   - Enable database access alerts
   - Set up monitoring and alerts
   - Configure backup schedule


2.4 REDIS SETUP (PRODUCTION - OPTIONAL BUT RECOMMENDED)
--------------------------------------------------------

Option 1: AWS ElastiCache (Recommended)

1. Create ElastiCache Redis cluster:
   - Go to AWS Console → ElastiCache → Redis clusters
   - Click "Create cluster"
   - Configure:
     * Name: tavily-redis
     * Engine: Redis 7.x or 6.x
     * Node type: cache.t3.small (or larger for production)
     * Number of replicas: 1+ (for high availability)
     * Subnet group: Same VPC as Elastic Beanstalk
     * Security group: Create new or select existing

2. Configure security groups:
   - ElastiCache security group:
     * Inbound: Custom TCP, Port 6379
     * Source: Elastic Beanstalk security group
   - Elastic Beanstalk security group:
     * Outbound: Allow to ElastiCache security group on port 6379

3. Enable AUTH token (production):
   - When creating cluster: Enable "AUTH token"
   - Set strong password
   - Save password securely

4. Get Redis endpoint:
   - After cluster creation, copy "Primary endpoint"
   - Format: tavily-redis.xxxxx.0001.use1.cache.amazonaws.com:6379

5. Set environment variables in Elastic Beanstalk:
   USE_REDIS_CACHE=true
   REDIS_HOST=tavily-redis.xxxxx.0001.use1.cache.amazonaws.com
   REDIS_PORT=6379
   REDIS_DB=0
   REDIS_PASSWORD=your_redis_password

   OR use REDIS_URL format:
   USE_REDIS_CACHE=true
   REDIS_URL=redis://:password@tavily-redis.xxxxx.cache.amazonaws.com:6379/0

6. Verify VPC configuration:
   - Elastic Beanstalk and ElastiCache must be in same VPC
   - Check EB environment VPC: Configuration → Network
   - Ensure ElastiCache is in same VPC

Option 2: Redis Cloud (Alternative)

1. Sign up at https://redis.com/cloud
2. Create database
3. Get connection URL
4. Set environment variable:
   USE_REDIS_CACHE=true
   REDIS_URL=redis://username:password@host:port/db


================================================================================
PART 3: ENVIRONMENT VARIABLES REFERENCE
================================================================================

3.1 BACKEND ENVIRONMENT VARIABLES
-----------------------------------

Required Variables:

OPENAI_API_KEY
  - Description: OpenAI API key for AI analysis
  - Example: sk-...
  - Where to get: https://platform.openai.com/api-keys
  - Development: Set in .env file
  - Production: Set in Elastic Beanstalk environment variables

TAVILY_API_KEY
  - Description: Tavily API key for news aggregation
  - Example: tvly-...
  - Where to get: https://tavily.com/
  - Development: Set in .env file
  - Production: Set in Elastic Beanstalk environment variables

MONGODB_URI
  - Description: MongoDB connection string
  - Example: mongodb+srv://user:pass@cluster.mongodb.net/dbname?retryWrites=true&w=majority
  - Development: Set in .env file
  - Production: Set in Elastic Beanstalk environment variables

Optional Variables:

USE_REDIS_CACHE
  - Description: Enable Redis caching (true/false)
  - Default: false
  - Development: false (unless testing Redis)
  - Production: true (recommended)

REDIS_URL
  - Description: Redis connection URL (alternative to individual params)
  - Example: redis://:password@host:port/db
  - Alternative to: REDIS_HOST, REDIS_PORT, REDIS_DB, REDIS_PASSWORD

REDIS_HOST
  - Description: Redis hostname
  - Example: tavily-redis.xxxxx.cache.amazonaws.com
  - Required if: USE_REDIS_CACHE=true and REDIS_URL not set

REDIS_PORT
  - Description: Redis port
  - Default: 6379
  - Required if: USE_REDIS_CACHE=true and REDIS_URL not set

REDIS_DB
  - Description: Redis database number
  - Default: 0
  - Required if: USE_REDIS_CACHE=true and REDIS_URL not set

REDIS_PASSWORD
  - Description: Redis AUTH password
  - Required if: Redis AUTH is enabled
  - Production: Recommended to enable AUTH

CORS_ORIGINS
  - Description: Allowed CORS origins (comma-separated)
  - Example: http://localhost:3000,https://your-app.vercel.app
  - Development: http://localhost:3000
  - Production: Your Vercel domain(s)

LOG_LEVEL
  - Description: Logging level
  - Options: DEBUG, INFO, WARNING, ERROR
  - Development: INFO or DEBUG
  - Production: WARNING or ERROR

ENVIRONMENT
  - Description: Environment identifier
  - Options: development, production
  - Development: development
  - Production: production
  - Note: Disables debug endpoints in production


3.2 FRONTEND ENVIRONMENT VARIABLES
-----------------------------------

Required Variables:

BACKEND_URL
  - Description: Backend API URL
  - Example: https://tavily-backend-env.eba-xxx.elasticbeanstalk.com
  - Development: http://localhost:8000 (default if not set)
  - Production: Your Elastic Beanstalk URL
  - Where to set:
    * Development: .env.local (optional, defaults to localhost:8000)
    * Production: Vercel dashboard → Settings → Environment Variables

Optional Variables:

NODE_ENV
  - Description: Node environment
  - Values: development, production
  - Automatically set by Vercel/Next.js
  - Do not manually set unless needed


================================================================================
PART 4: CORS CONFIGURATION
================================================================================

4.1 BACKEND CORS SETUP
----------------------

The backend automatically configures CORS based on CORS_ORIGINS environment variable.

Development:
  CORS_ORIGINS=http://localhost:3000

Production:
  CORS_ORIGINS=https://your-frontend.vercel.app

Multiple origins:
  CORS_ORIGINS=http://localhost:3000,https://your-frontend.vercel.app,https://preview.vercel.app

Verification:
  1. Check backend logs for CORS errors
  2. Test API calls from frontend
  3. Check browser console for CORS errors


4.2 FRONTEND CORS HANDLING
---------------------------

The frontend uses Next.js API routes as proxies to avoid CORS issues.

API routes:
  - /api/analyze → Proxies to backend /api/analyze/start
  - /api/run/[run_id] → Proxies to backend /api/run/{run_id}
  - /api/runs/recent → Proxies to backend /api/runs/recent

Backend URL configuration:
  - Set BACKEND_URL in Vercel environment variables
  - Frontend automatically uses this for API calls
  - No CORS issues since requests go through Next.js server


================================================================================
PART 5: POST-DEPLOYMENT VERIFICATION
================================================================================

5.1 BACKEND VERIFICATION
-------------------------

1. Health check:
   curl https://your-backend.elasticbeanstalk.com/health
   Expected: {"status":"ok","message":"Service is running"}

2. Readiness check:
   curl https://your-backend.elasticbeanstalk.com/health/ready
   Expected: Status with dependency checks (MongoDB, APIs)

3. API documentation:
   Visit: https://your-backend.elasticbeanstalk.com/docs
   Should show Swagger UI

4. Test endpoint:
   curl -X POST https://your-backend.elasticbeanstalk.com/api/analyze/start \
     -H "Content-Type: application/json" \
     -d '{"market_url":"https://polymarket.com/event/test"}'
   Expected: {"run_id":"run-..."}


5.2 FRONTEND VERIFICATION
--------------------------

1. Visit deployed URL:
   https://your-project.vercel.app

2. Check browser console:
   - No CORS errors
   - No network errors
   - API calls succeed

3. Test analysis:
   - Enter a Polymarket URL
   - Verify analysis starts
   - Check that results appear

4. Check API routes:
   - Test /api/analyze endpoint
   - Verify it proxies to backend correctly


5.3 DATABASE VERIFICATION
-------------------------

1. Check MongoDB connection:
   - Backend logs should show successful connection
   - Test endpoint: /ping-db (if available)

2. Verify data persistence:
   - Run an analysis
   - Check MongoDB Atlas → Collections
   - Verify run document was created

3. Check Recent Sessions:
   - Frontend should load recent runs
   - Verify data appears in sidebar


5.4 REDIS VERIFICATION (IF ENABLED)
------------------------------------

1. Check backend logs:
   - Should show: "Redis cache connected"
   - No connection errors

2. Test caching:
   - Make same API request twice
   - Second request should be faster (cached)

3. Monitor Redis:
   - AWS ElastiCache → Metrics
   - Check connection count, memory usage


================================================================================
PART 6: TROUBLESHOOTING
================================================================================

6.1 BACKEND ISSUES
------------------

Issue: Backend fails to start
  - Check: eb logs
  - Verify: All environment variables are set
  - Verify: Python version matches runtime.txt (3.11)
  - Verify: Dependencies installed correctly

Issue: MongoDB connection fails
  - Check: MONGODB_URI is correct
  - Verify: IP whitelist includes Elastic Beanstalk IPs
  - Verify: Database user credentials are correct
  - Check: Network connectivity (security groups)

Issue: OpenAI API errors
  - Verify: OPENAI_API_KEY is set correctly
  - Check: API key has sufficient credits
  - Check: Circuit breaker status (may need reset)
  - Reset: POST /api/reset-circuit-breaker

Issue: CORS errors
  - Verify: CORS_ORIGINS includes frontend domain
  - Check: No trailing slashes in URLs
  - Verify: Environment variable is set correctly

Issue: Redis connection fails
  - Verify: Redis and EB are in same VPC
  - Check: Security groups allow port 6379
  - Verify: Redis endpoint is correct
  - Check: Redis AUTH password if enabled
  - Note: App will fall back to in-memory cache


6.2 FRONTEND ISSUES
--------------------

Issue: Build fails on Vercel
  - Check: Root directory is set to "frontend"
  - Verify: package.json exists in frontend/
  - Check: Node.js version compatibility
  - Review: Build logs in Vercel dashboard

Issue: API calls fail
  - Verify: BACKEND_URL is set in Vercel
  - Check: Backend is accessible from internet
  - Verify: CORS is configured correctly
  - Test: Backend URL directly in browser

Issue: Environment variables not working
  - Note: Next.js env vars are build-time only
  - Redeploy: After adding environment variables
  - Verify: Variables are set for correct environment (Production/Preview)

Issue: 404 errors on API routes
  - Verify: API route files exist in app/api/
  - Check: File naming matches route structure
  - Review: Next.js routing documentation


6.3 DEPLOYMENT ISSUES
----------------------

Issue: EB deployment fails
  - Check: eb logs for errors
  - Verify: All required files are present
  - Check: Procfile syntax is correct
  - Verify: Python version in runtime.txt

Issue: Vercel deployment fails
  - Check: Build logs in Vercel dashboard
  - Verify: Root directory is correct
  - Check: Dependencies in package.json
  - Verify: No TypeScript errors

Issue: Environment variables not persisting
  - Verify: Set via correct method (CLI vs Dashboard)
  - Check: Variables are set for correct environment
  - Redeploy: After setting variables


================================================================================
PART 7: SECURITY BEST PRACTICES
================================================================================

7.1 API KEYS AND SECRETS
-------------------------

DO:
  - Store secrets in environment variables (never in code)
  - Use AWS Systems Manager Parameter Store for sensitive values
  - Rotate API keys regularly
  - Use different keys for development and production
  - Enable MFA on all accounts (OpenAI, Tavily, MongoDB, AWS)

DON'T:
  - Commit .env files to git
  - Hardcode API keys in source code
  - Share API keys in chat/email
  - Use production keys in development


7.2 DATABASE SECURITY
----------------------

DO:
  - Use strong database passwords
  - Whitelist specific IPs (not 0.0.0.0/0) in production
  - Enable MongoDB encryption at rest
  - Use VPC peering for better security (advanced)
  - Enable database access alerts

DON'T:
  - Use default database credentials
  - Allow all IPs in production (0.0.0.0/0)
  - Store connection strings in code


7.3 REDIS SECURITY
-------------------

DO:
  - Enable AUTH token in production
  - Use strong Redis passwords
  - Restrict access via security groups
  - Use VPC for network isolation
  - Monitor Redis access logs

DON'T:
  - Expose Redis to public internet
  - Use default Redis configuration
  - Disable AUTH in production


7.4 CORS SECURITY
-----------------

DO:
  - Specify exact frontend domains (not *)
  - Use HTTPS in production
  - Regularly review CORS_ORIGINS

DON'T:
  - Allow all origins (*) in production
  - Use HTTP in production


================================================================================
PART 8: MONITORING AND MAINTENANCE
================================================================================

8.1 BACKEND MONITORING
----------------------

AWS Elastic Beanstalk:
  - Monitor: CPU, memory, request count
  - Set up: CloudWatch alarms
  - Review: Application logs regularly
  - Check: Health dashboard

Application Logs:
  - View: eb logs
  - Monitor: Error rates, response times
  - Set up: Log aggregation (CloudWatch Logs)


8.2 FRONTEND MONITORING
-----------------------

Vercel:
  - Monitor: Deployment status
  - Review: Function logs
  - Check: Analytics (if enabled)
  - Monitor: Build times

Application:
  - Monitor: API call success rates
  - Check: Browser console for errors
  - Review: User feedback


8.3 DATABASE MONITORING
------------------------

MongoDB Atlas:
  - Monitor: Connection count, query performance
  - Set up: Alerts for high usage
  - Review: Slow query logs
  - Monitor: Storage usage

Backup:
  - Enable: Automated backups
  - Test: Backup restoration
  - Schedule: Regular backup verification


8.4 REDIS MONITORING
---------------------

AWS ElastiCache:
  - Monitor: CPU, memory usage
  - Check: Connection count
  - Review: Cache hit rate
  - Set up: CloudWatch alarms

Application:
  - Monitor: Cache effectiveness
  - Review: Fallback to in-memory cache frequency


================================================================================
PART 9: QUICK REFERENCE COMMANDS
================================================================================

9.1 BACKEND COMMANDS
--------------------

Development:
  cd backend
  python -m uvicorn app.main:app --reload --port 8000

Deployment:
  cd backend
  eb init                    # First time only
  eb create env-name         # Create environment
  eb setenv KEY=value        # Set environment variable
  eb deploy                  # Deploy application
  eb status                  # Check status
  eb logs                    # View logs
  eb ssh                     # SSH into instance
  eb open                    # Open in browser

Create deployment ZIP:
  cd backend
  python create_zip.py


9.2 FRONTEND COMMANDS
---------------------

Development:
  cd frontend
  npm install
  npm run dev

Deployment (Vercel CLI):
  cd frontend
  vercel login
  vercel                    # Deploy to preview
  vercel --prod             # Deploy to production
  vercel env add KEY         # Add environment variable

Build:
  npm run build             # Production build
  npm test                  # Run tests


9.3 DATABASE COMMANDS
---------------------

MongoDB Atlas:
  - Use web console for management
  - Connection string format:
    mongodb+srv://user:pass@cluster.mongodb.net/dbname?retryWrites=true&w=majority


9.4 REDIS COMMANDS
------------------

Test connection (SSH into EB):
  python3 -c "import redis; r=redis.Redis(host='endpoint', port=6379); print(r.ping())"

Check status (AWS Console):
  ElastiCache → Redis clusters → Your cluster


================================================================================
PART 10: DEPLOYMENT CHECKLIST
================================================================================

PRE-DEPLOYMENT:
  [ ] All environment variables documented
  [ ] API keys obtained and secured
  [ ] MongoDB cluster created and configured
  [ ] Redis cluster created (if using)
  [ ] Security groups configured
  [ ] CORS origins identified

BACKEND DEPLOYMENT:
  [ ] EB CLI installed and configured
  [ ] Elastic Beanstalk environment created
  [ ] Environment variables set
  [ ] Application deployed successfully
  [ ] Health checks passing
  [ ] API documentation accessible
  [ ] Test endpoint works

FRONTEND DEPLOYMENT:
  [ ] Vercel account created
  [ ] Repository connected
  [ ] Root directory set to "frontend"
  [ ] BACKEND_URL environment variable set
  [ ] Build succeeds
  [ ] Application accessible
  [ ] API calls work correctly

POST-DEPLOYMENT:
  [ ] Backend health check passes
  [ ] Frontend loads without errors
  [ ] Analysis can be submitted
  [ ] Results appear correctly
  [ ] Recent sessions load
  [ ] MongoDB connection verified
  [ ] Redis connection verified (if enabled)
  [ ] CORS configured correctly
  [ ] Monitoring set up
  [ ] Alerts configured

SECURITY:
  [ ] API keys secured (not in code)
  [ ] Database IP whitelist configured
  [ ] Redis AUTH enabled (production)
  [ ] CORS origins restricted
  [ ] HTTPS enabled (Vercel default)
  [ ] Secrets in Parameter Store (if applicable)

================================================================================

For additional help:
- Backend issues: Check eb logs
- Frontend issues: Check Vercel deployment logs
- Database issues: Check MongoDB Atlas dashboard
- Redis issues: Check ElastiCache metrics

