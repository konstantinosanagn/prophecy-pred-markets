AGENT ROLES AND LANGGRAPH FLOW DOCUMENTATION
=============================================

This document provides a detailed description of the multi-agent analysis system,
including each agent's role, responsibilities, and how they orchestrate together
through the LangGraph execution flow.

================================================================================
OVERVIEW
================================================================================

The prophily system uses a multi-agent architecture to analyze Polymarket prediction
markets. The analysis is orchestrated through a sequential LangGraph flow where each
agent processes the shared AgentState and enriches it with new information.

Key Design Principles:
- Sequential execution: Agents run in a specific order due to dependencies
- Shared state: All agents read from and write to a common AgentState dictionary
- Graceful degradation: Each agent has fallback mechanisms if external services fail
- Configuration-driven: Agent behavior can be customized via configuration options
- Caching: API calls are cached to reduce costs and improve performance

================================================================================
AGENT STATE STRUCTURE
================================================================================

The AgentState is a TypedDict that serves as the shared memory between all agents.
It contains:

Core Identifiers:
- run_id: Unique identifier for this analysis run
- run_at: Timestamp of when analysis started
- market_url: Original Polymarket URL
- slug: Market/event slug extracted from URL
- selected_market_slug: Selected market when event has multiple markets

Market Data:
- market: MarketDocument with question, outcomes, yes_index, etc.
- market_snapshot: MarketSnapshot with current prices, volume, liquidity
- event: EventDocument with event metadata
- event_context: EventContext with title, description, category

News Data:
- tavily_queries: List of TavilyQuerySpec (generated by tavily_prompt_agent)
- news_context: NewsContext with articles, summary, sentiment analysis

Analysis Results:
- signal: Signal with probabilities, edge, Kelly sizing, confidence
- decision: Decision with action (BUY/SELL/HOLD), edge_pct, notes
- report: ReportBlock with headline, thesis, bull/bear cases, risks

Configuration:
- horizon: Time horizon (intraday, 24h, resolution)
- strategy_preset: Risk preset (Cautious, Balanced, Aggressive)
- strategy_params: Strategy parameter overrides
- config: Analysis configuration (agent toggles, limits, etc.)

Position Tracking (for future use):
- position_side: Current position (flat, long_yes, long_no)
- position_size_fraction: Current position size
- position_avg_price: Average entry price

================================================================================
LANGGRAPH EXECUTION FLOW
================================================================================

The analysis graph executes agents sequentially in the following order:

┌─────────────────────────────────────────────────────────────────┐
│                    ANALYSIS GRAPH FLOW                          │
└─────────────────────────────────────────────────────────────────┘

1. market_agent
   ↓ (provides: market_snapshot, event metadata)
   
2. event_agent
   ↓ (provides: event_context)
   
3. tavily_prompt_agent (optional, can be disabled)
   ↓ (provides: tavily_queries)
   
4. news_agent
   ↓ (provides: news_context with articles)
   
5. news_summary_agent (optional, can be disabled)
   ↓ (provides: news_context.summary)
   
6. prob_agent
   ↓ (provides: signal with probabilities)
   
7. strategy_agent
   ↓ (provides: signal with action/sizing, decision)
   
8. report_agent
   ↓ (provides: report with comprehensive analysis)
   
   [COMPLETE]

Each agent depends on outputs from previous agents. The flow cannot be parallelized
due to these dependencies, but individual agents may use parallel processing internally
(e.g., news_agent can fetch multiple Tavily queries concurrently).

================================================================================
AGENT 1: MARKET AGENT
================================================================================

File: backend/app/agents/market_agent.py

Role:
The Market Agent is the entry point of the analysis pipeline. It extracts and
normalizes market data from Polymarket API, handles market selection for events
with multiple markets, and builds the initial market snapshot.

Responsibilities:
1. Extract slug from Polymarket URL
2. Fetch event and market data from Polymarket Gamma API
3. Detect if URL points to an event (multiple markets) or single market
4. Handle market selection logic:
   - If event with multiple markets and no selection: request user selection
   - If event with single market: auto-select
   - If direct market URL: use directly
5. Build market snapshot with:
   - Current YES/NO prices
   - Best bid/ask spreads
   - Volume and liquidity metrics
   - Order book data (if available)
   - Market end date
6. Store event metadata (title, image, volume, comment counts)
7. Normalize market data into canonical format

Inputs (from AgentState):
- market_url: Polymarket URL to analyze
- selected_market_slug: Pre-selected market slug (if any)
- slug: Market slug (if already extracted)

Outputs (into AgentState):
- market: MarketDocument with normalized market data
- market_snapshot: MarketSnapshot with current market state
- event: EventDocument with event metadata
- market_options: List of available markets (if event)
- requires_market_selection: Boolean flag (if user must select)
- slug: Extracted market/event slug
- polymarket_url: Normalized Polymarket URL

Dependencies:
- Polymarket Gamma API (with caching, retry, circuit breaker)
- Polymarket CLOB API (for order book data)

Error Handling:
- Falls back to placeholder data if API fails
- Handles missing fields gracefully
- Logs warnings for non-critical failures

Special Behavior:
- If requires_market_selection is True, graph execution stops early
- User must select a market before analysis continues
- Market selection is handled via frontend UI

================================================================================
AGENT 2: EVENT AGENT
================================================================================

File: backend/app/agents/event_agent.py

Role:
The Event Agent normalizes event metadata and provides denormalized context
for downstream agents. It processes event-level information that was collected
by the Market Agent.

Responsibilities:
1. Derive event slug from market slug (if not provided)
2. Normalize event metadata:
   - Title, description, category
   - End date
   - Image URL
   - Volume and comment counts
3. Build event_context for UI and downstream agents
4. Preserve original API data (commentCount, volume24hr) from Market Agent

Inputs (from AgentState):
- event: EventDocument (from market_agent)
- slug: Market slug
- market_snapshot: MarketSnapshot (for context)

Outputs (into AgentState):
- event: Normalized EventDocument
- event_context: EventContext with title, description, category, image, etc.
- event_description: Full event description text

Dependencies:
- None (processes data already in state)

Error Handling:
- Uses fallback values for missing fields
- Preserves original API data when available
- Handles None/0 values correctly (allows 0 commentCount)

Special Behavior:
- Can run in parallel with other agents (no external dependencies)
- Currently runs sequentially for simplicity
- Preserves commentCount and volume24hr from API (important for UI)

================================================================================
AGENT 3: TAVILY PROMPT AGENT (OPTIONAL)
================================================================================

File: backend/app/agents/tavily_prompt_agent.py

Role:
The Tavily Prompt Agent uses OpenAI to generate optimized search queries for
the Tavily news API. It transforms market context into structured query
specifications that will yield the most relevant news articles.

Responsibilities:
1. Build prompt from market and event context
2. Call OpenAI API to generate 1-3 optimized Tavily queries
3. Parse and validate LLM response (JSON format)
4. Create TavilyQuerySpec objects with:
   - Query name (e.g., "latest_developments")
   - Natural language query string
   - Max results per query (5-12)
   - Search depth (basic/advanced)
   - Optional timeframe (24h, 7d, 30d)
5. Cache queries to avoid redundant API calls

Inputs (from AgentState):
- market_snapshot: MarketSnapshot (question, outcomes)
- event_context: EventContext (title, category, description)
- horizon: Time horizon (intraday, 24h, resolution)
- strategy_preset: Strategy preset (for context)

Outputs (into AgentState):
- tavily_queries: List[TavilyQuerySpec] (only if successful)

Dependencies:
- OpenAI API (gpt-4o-mini model)
- Circuit breaker for resilience
- Caching layer

Error Handling:
- If OpenAI fails: Does not set tavily_queries (news_agent uses fallback)
- If JSON parsing fails: Logs warning, falls back
- If circuit breaker open: Skips generation, falls back
- All errors are non-fatal (news_agent handles gracefully)

Configuration:
- Can be disabled via config.use_tavily_prompt_agent = False
- When disabled: news_agent uses simple keyword-based fallback queries

Special Behavior:
- Queries are optimized for the analysis horizon:
  * "intraday": Emphasizes latest developments, breaking news
  * "24h": Mix of latest updates + near-term catalysts
  * "resolution": Structural factors, long-term drivers, fundamentals
- Cache key includes horizon, slug, and strategy_preset
- Different horizons generate different queries for same market

Example Generated Queries:
- "Latest FOMC meeting minutes and Fed Chair commentary on interest rates"
- "Inflation data releases and CPI expectations for December 2024"
- "Market expectations and analyst consensus on Fed rate decision"

================================================================================
AGENT 4: NEWS AGENT
================================================================================

File: backend/app/agents/news_agent.py

Role:
The News Agent aggregates relevant news articles from Tavily API using the
queries generated by Tavily Prompt Agent (or fallback queries). It performs
sentiment analysis on articles and structures the news context.

Responsibilities:
1. Normalize tavily_queries from state (handles both string and TavilyQuerySpec)
2. Use fallback queries if tavily_queries not available
3. Execute Tavily searches for each query
4. Collect and deduplicate articles by URL
5. Perform sentiment analysis on articles (if enabled):
   - Classify as bullish, bearish, or neutral
   - Based on market question and current prices
6. Limit articles based on configuration (max_articles)
7. Build news_context with:
   - Articles with sentiment
   - Query results with metadata
   - Combined summary (brief heuristic summary)

Inputs (from AgentState):
- tavily_queries: List[TavilyQuerySpec] (from tavily_prompt_agent)
- market_snapshot: MarketSnapshot (for sentiment analysis context)
- event_context: EventContext (for fallback queries)
- config: Configuration (max_articles, enable_sentiment_analysis)

Outputs (into AgentState):
- news_context: NewsContext with:
  - articles: List of articles with sentiment
  - queries: Structured query results
  - tavily_queries: List of query strings (backward compatibility)
  - combined_summary: Brief summary (placeholder, replaced by news_summary_agent)

Dependencies:
- Tavily Search API
- Sentiment analyzer (if enabled)
- Caching layer (Tavily responses are cached)

Error Handling:
- If tavily_queries missing: Uses fallback keyword-based queries
- If Tavily API fails: Returns empty news_context (non-fatal)
- If sentiment analysis fails: Articles marked as neutral
- All errors are logged but don't stop execution

Configuration:
- max_articles: Total articles to include (default: 15, range: 5-30)
- max_articles_per_query: Max results per query (default: 8, range: 5-12)
- enable_sentiment_analysis: Toggle sentiment analysis (default: true)

Special Behavior:
- Articles are deduplicated by URL
- Sentiment analysis considers:
  * Market question
  * Current YES price
  * Signal direction (if available)
  * Market outcomes
- Query results include Tavily's AI-generated answers (if available)
- Supports both legacy (string) and new (TavilyQuerySpec) query formats

================================================================================
AGENT 5: NEWS SUMMARY AGENT (OPTIONAL)
================================================================================

File: backend/app/agents/news_summary_agent.py

Role:
The News Summary Agent generates a comprehensive summary of collected news
articles using OpenAI. The summary is weighted towards the sentiment category
with the most articles but includes perspectives from all categories.

Responsibilities:
1. Extract articles with sentiment from news_context
2. Generate comprehensive summary using OpenAI:
   - Weighted towards dominant sentiment category
   - Includes perspectives from all sentiment categories
   - Synthesizes information relevant to market question
3. Use fallback summary if OpenAI unavailable:
   - Uses Tavily answers if available
   - Or simple heuristic summary
4. Update news_context with generated summary

Inputs (from AgentState):
- news_context: NewsContext with articles (from news_agent)
- event_context: EventContext (for context)
- market_snapshot: MarketSnapshot (for context)

Outputs (into AgentState):
- news_context.summary: Comprehensive news summary (string)

Dependencies:
- OpenAI API (gpt-4o-mini model)
- Circuit breaker for resilience

Error Handling:
- If OpenAI fails: Uses fallback heuristic summary
- If too few articles (< 2): Uses simple fallback
- If no articles: Uses generic fallback message
- All errors are non-fatal

Configuration:
- Can be disabled via config.use_news_summary_agent = False
- When disabled: Uses simple heuristic summary

Special Behavior:
- Requires at least 2 articles for meaningful sentiment-weighted summary
- Summary considers:
  * Event title and market question
  * All articles with their sentiment classifications
  * Weighted towards dominant sentiment but includes all perspectives
- Fallback summary uses Tavily answers or article titles

Example Summary:
"Recent coverage on Fed interest rate decision highlights mixed sentiment.
Bullish articles (60%) emphasize strong economic data and inflation moderation,
while bearish articles (30%) point to labor market tightness. Neutral coverage
(10%) focuses on Fed communication and forward guidance."

================================================================================
AGENT 6: PROBABILITY AGENT
================================================================================

File: backend/app/agents/prob_agent.py

Role:
The Probability Agent (also called Signal Agent) generates trading signals by
combining market data, news context, and AI analysis. It computes probabilities,
edge, Kelly sizing, and confidence levels.

Responsibilities:
1. Infer market probability (p_mkt) from market snapshot (YES price)
2. Call OpenAI to generate model probability (p_model) based on:
   - Event title and market question
   - Current market price
   - News summary and top headlines
   - Market context
3. Compute core signal quantities:
   - Edge percentage: p_model - p_mkt
   - Expected value per dollar
   - Kelly fraction for YES and NO positions
   - Confidence level and score
4. Create Signal model with all computed values
5. Use fallback signal if OpenAI unavailable

Inputs (from AgentState):
- market_snapshot: MarketSnapshot (for p_mkt inference)
- event_context: EventContext (for context)
- news_context: NewsContext (summary, articles, headlines)
- horizon: Time horizon

Outputs (into AgentState):
- signal: Signal model with:
  - market_prob: Market-implied probability
  - model_prob: AI-estimated probability
  - edge_pct: Edge percentage
  - expected_value_per_dollar: Expected value
  - kelly_fraction_yes: Kelly sizing for YES
  - kelly_fraction_no: Kelly sizing for NO
  - confidence_level: low/medium/high
  - confidence_score: 0.0-1.0
  - rationale_short: Brief explanation
  - horizon: Time horizon

Dependencies:
- OpenAI API (gpt-4o-mini model)
- Signal utilities (edge calculation, Kelly sizing, confidence estimation)
- Circuit breaker for resilience

Error Handling:
- If OpenAI fails: Uses fallback signal with default delta (+0.07)
- If parsing fails: Uses fallback signal
- Fallback signal has medium confidence and hold action

Special Behavior:
- Confidence estimation uses heuristic based on:
  * News article count
  * Edge magnitude
  * News summary quality
- LLM confidence can override heuristic if provided
- Kelly fractions can be negative (indicating opposite position)
- Signal action and sizing are set by strategy_agent (not prob_agent)

Example Signal:
{
  "market_prob": 0.65,
  "model_prob": 0.72,
  "edge_pct": 0.07,
  "kelly_fraction_yes": 0.12,
  "kelly_fraction_no": -0.12,
  "confidence_level": "high",
  "confidence_score": 0.75,
  "rationale_short": "Strong economic data and Fed dovish pivot suggest higher probability"
}

================================================================================
AGENT 7: STRATEGY AGENT
================================================================================

File: backend/app/agents/strategy_agent.py

Role:
The Strategy Agent evaluates the signal from Probability Agent and makes concrete
trading decisions. It applies risk management rules, position sizing constraints,
and generates actionable recommendations.

Responsibilities:
1. Load strategy preset defaults (Cautious, Balanced, Aggressive)
2. Merge user-provided strategy_params overrides
3. Evaluate signal against strategy thresholds:
   - Check risk_off flag
   - Check confidence threshold (min_confidence)
   - Check edge threshold (min_edge_pct)
4. Determine recommended action:
   - buy_yes: Long YES position
   - buy_no: Long NO position
   - reduce_yes: Reduce YES position
   - reduce_no: Reduce NO position
   - hold: No action
5. Calculate position sizing:
   - Apply Kelly fraction with strategy caps
   - Consider current position (if any)
   - Apply max_capital_pct limit
   - Apply max_kelly_fraction cap
6. Set take-profit and stop-loss targets
7. Update signal with action and sizing
8. Create decision dict for backward compatibility

Inputs (from AgentState):
- signal: Signal model (from prob_agent)
- strategy_preset: Risk preset (Cautious, Balanced, Aggressive)
- strategy_params: User parameter overrides
- position_side: Current position (for future use)
- position_size_fraction: Current position size (for future use)

Outputs (into AgentState):
- signal: Updated Signal with:
  - recommended_action: buy_yes/buy_no/reduce_yes/reduce_no/hold
  - recommended_size_fraction: Position size (0.0-1.0)
  - target_take_profit_prob: Take profit probability
  - target_stop_loss_prob: Stop loss probability
- decision: Decision dict with action, edge_pct, notes

Dependencies:
- Signal utilities (for Kelly calculations)
- None (pure decision logic)

Error Handling:
- If signal missing: Creates minimal signal with hold action
- If signal is dict (legacy): Converts to Signal model
- Handles all edge cases gracefully

Strategy Presets:

Cautious:
- min_edge_pct: 0.08 (8%)
- min_confidence: high
- max_capital_pct: 0.08 (8%)
- max_kelly_fraction: 0.15 (15% of full Kelly)

Balanced (default):
- min_edge_pct: 0.05 (5%)
- min_confidence: medium
- max_capital_pct: 0.15 (15%)
- max_kelly_fraction: 0.25 (25% of full Kelly)

Aggressive:
- min_edge_pct: 0.03 (3%)
- min_confidence: low
- max_capital_pct: 0.25 (25%)
- max_kelly_fraction: 0.5 (50% of full Kelly)

Decision Logic:
1. If risk_off: HOLD
2. If confidence < min_confidence: HOLD
3. If |edge| < min_edge_pct: HOLD
4. If edge > 0: BUY YES (or reduce if already long)
5. If edge < 0: BUY NO (or reduce if already long)
6. Size = min(Kelly * max_kelly_fraction, max_capital_pct)
7. TP/SL set based on edge magnitude

Special Behavior:
- Position-aware: Considers current position when making recommendations
- Kelly capping: Never uses full Kelly (too risky)
- Multiple caps: Both Kelly fraction and capital percentage limits
- Take profit: Set at 80% of edge
- Stop loss: Set at 50% of edge (opposite direction)

================================================================================
AGENT 8: REPORT AGENT
================================================================================

File: backend/app/agents/report_agent.py

Role:
The Report Agent generates a comprehensive analysis report that synthesizes all
information from previous agents into a structured, readable format. It creates
both structured fields and markdown for display.

Responsibilities:
1. Extract all relevant data from state:
   - Market snapshot
   - Signal and decision
   - Event context
   - News context with sentiment
2. Generate structured report using OpenAI:
   - Headline: 1 sentence summary
   - Thesis: 3-5 sentences tying everything together
   - Bull case: 2-4 bullet points
   - Bear case: 2-4 bullet points
   - Key risks: 2-4 bullet points
   - Execution notes: 2-3 sentences on sizing, TP/SL, re-check timing
3. Use fallback template if OpenAI unavailable
4. Add legacy markdown field for backward compatibility
5. Set environment metadata (model versions, etc.)

Inputs (from AgentState):
- market_snapshot: MarketSnapshot
- signal: Signal model
- decision: Decision dict
- event_context: EventContext
- news_context: NewsContext

Outputs (into AgentState):
- report: ReportBlock with:
  - headline: Summary headline
  - thesis: Main thesis
  - bull_case: List of bullish points
  - bear_case: List of bearish points
  - key_risks: List of risks
  - execution_notes: Trading execution guidance
  - title: Legacy field (same as headline)
  - markdown: Legacy markdown format
- env: RunEnvMetadata with model versions

Dependencies:
- OpenAI API (gpt-4o-mini model)
- Circuit breaker for resilience

Error Handling:
- If OpenAI fails: Uses fallback template report
- If JSON parsing fails: Uses fallback
- If required fields missing: Uses fallback
- Always returns valid report (never fails completely)

Special Behavior:
- Report includes sentiment distribution from news
- Synthesizes market data, news, signal, and decision
- Provides actionable trading guidance
- Maintains backward compatibility with markdown format

Example Report Structure:
{
  "headline": "Model sees 72% vs market 65% - 7% edge with high confidence",
  "thesis": "Our analysis of recent Fed commentary and economic data suggests...",
  "bull_case": [
    "Strong inflation moderation supports dovish pivot",
    "Labor market cooling reduces pressure for rate hikes"
  ],
  "bear_case": [
    "Core inflation remains sticky above target",
    "Fed may prioritize credibility over growth"
  ],
  "key_risks": [
    "Unexpected economic data releases",
    "Fed communication changes"
  ],
  "execution_notes": "Enter 12% position size. Take profit at 70%, stop loss at 62%..."
}

================================================================================
EXECUTION FLOW DETAILS
================================================================================

Graph Initialization:
1. Generate unique run_id
2. Set run_at timestamp
3. Initialize state with input parameters
4. Set default values for missing fields

Sequential Execution:
Each agent runs sequentially, waiting for previous agent to complete. This ensures:
- Data dependencies are satisfied
- State is properly updated before next agent reads it
- Errors can be handled gracefully at each step

State Updates:
- Each agent reads from AgentState
- Each agent writes to AgentState
- State is passed by reference (mutated in place)
- Previous agent outputs become next agent inputs

Error Propagation:
- If agent fails: State may have partial data
- Next agent handles missing data gracefully
- Fallback mechanisms at each step
- Analysis never completely fails (always produces some output)

Configuration-Driven Behavior:
- Agents check config flags before executing optional steps
- Configuration can disable agents (tavily_prompt_agent, news_summary_agent)
- Configuration controls limits (max_articles, max_articles_per_query)
- Configuration controls features (enable_sentiment_analysis)

Caching Strategy:
- Polymarket API responses: Cached by slug
- Tavily API responses: Cached by query
- OpenAI responses: Cached by prompt hash
- Cache keys include relevant parameters (horizon, strategy, etc.)

Performance Considerations:
- Total execution time: ~30-60 seconds (depending on API response times)
- Most time spent on:
  * OpenAI API calls (3-4 calls per analysis)
  * Tavily API calls (1-3 calls per analysis)
  * Network latency
- Caching significantly reduces repeat analysis time

================================================================================
CONFIGURATION OPTIONS
================================================================================

Agent Toggles:
- use_tavily_prompt_agent: Enable/disable AI query generation (default: true)
- use_news_summary_agent: Enable/disable AI news summary (default: true)

Article Limits:
- max_articles: Total articles in analysis (default: 15, range: 5-30)
- max_articles_per_query: Max results per Tavily query (default: 8, range: 5-12)

Analysis Settings:
- min_confidence: Minimum confidence threshold (low/medium/high, default: medium)
- enable_sentiment_analysis: Enable sentiment analysis (default: true)

Strategy Settings:
- strategy_preset: Risk preset (Cautious, Balanced, Aggressive)
- strategy_params: Parameter overrides (min_edge_pct, max_capital_pct, etc.)

Time Horizon:
- horizon: Analysis timeframe (intraday, 24h, resolution)
- Affects query generation and signal interpretation

================================================================================
ERROR HANDLING AND RESILIENCE
================================================================================

Circuit Breakers:
- OpenAI API: Circuit breaker prevents cascading failures
- Auto-reset after timeout
- Manual reset via API endpoint

Fallback Mechanisms:
- Market Agent: Placeholder data if API fails
- Tavily Prompt Agent: Falls back to keyword queries
- News Agent: Empty news_context if API fails
- News Summary Agent: Heuristic summary if OpenAI fails
- Probability Agent: Default signal if OpenAI fails
- Strategy Agent: Hold action if signal invalid
- Report Agent: Template report if OpenAI fails

Graceful Degradation:
- Analysis continues even if some agents fail
- Partial results are still useful
- User always gets some output
- Errors are logged but don't stop execution

Retry Logic:
- API calls use tenacity for retries
- Exponential backoff
- Maximum retry attempts
- Timeout handling

================================================================================
FUTURE ENHANCEMENTS
================================================================================

Potential Improvements:
1. Parallel execution where possible (event_agent could run in parallel)
2. Streaming responses for real-time updates
3. Position tracking integration
4. Backtesting capabilities
5. Multi-market correlation analysis
6. Advanced sentiment analysis models
7. Custom agent plugins
8. A/B testing different agent strategies

================================================================================
SUMMARY
================================================================================

The multi-agent system transforms a single Polymarket URL into a comprehensive
trading analysis through 8 specialized agents working in sequence:

1. Market Agent: Fetches and normalizes market data
2. Event Agent: Processes event metadata
3. Tavily Prompt Agent: Generates optimized news queries (optional)
4. News Agent: Aggregates relevant news articles
5. News Summary Agent: Summarizes news with sentiment (optional)
6. Probability Agent: Generates trading signal with probabilities
7. Strategy Agent: Makes concrete trading decisions
8. Report Agent: Creates comprehensive analysis report

Each agent enriches the shared AgentState, building up a complete picture of
the market, news context, signal, and actionable recommendations. The system
is designed for resilience, with fallbacks at every step, ensuring users always
receive useful analysis even when external services fail.

